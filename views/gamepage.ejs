<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AvalonBeeX-training</title>
    <link rel="stylesheet" type="text/css" href="css/mainpage">
    <script src="socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <script>

    </script>
</head>

<body>
    <p>Chào
        <span id="playerName" value=<%=name %> >
            <%= name %>
        </span> đã đến với phòng:
        <span id="playerRoom" value=<%=room %> >
            <%= room %>
        </span> AvalonBeeX-training
    </p>
    <h2>Các người chơi trong phòng</h2>
    <div id="playerList">
    </div>

    <div id="teamleader" style="display: none">
        <p>Hãy lập team thực hiện nhiệm vụ</p>
        <button id="go" type="submit">OK</button>
    </div>

    <div id="system" style="display: none">
        <p>Team được lập bao gồm: </p>
        <div id="teammate"></div>
        <button id="TYes">Yes</button>
        <button id="TNo">Nope</button>
    </div>

    <div>
        <button id="start_game" type="submit" style="display:none">Start</button>
    </div>
    <div id="play_ground" style="display:none">
        Playground :
        <div id="player_role"></div>
    </div>
    <script> //script nay se dc dua di noi khac sau khi code xong

        //================================================================================================
        let socket = io("http://localhost:9090");
        let isHost = false;
        let myId;
        let myRole;
        let gameData;
        let voteTeamResult = [];

        socket.on('server-gui-cap-nhat-khung-nhin', function (membersArray) {
            $('#playerList').html("");
            membersArray.forEach(function (member) {
                $('#playerList').append('<li class="player">' + member + '</li>')
            })
        })
        socket.on('server-yeu-cau-hien-thi-nut-play', function () {
            if (isHost)
                $('#start_game').show(100);
        })
        socket.on('server-yeu-cau-dung-hien-thi-nut-play', function () {
            if (isHost)
                $('#start_game').hide(100);
        })
        socket.on('server-xac-nhan-id', function (pid) {
            myId = pid;
        })
        socket.on('server-xac-nhan-host', function () {
            isHost = true;
        })
        socket.on('server-gui-role', function (data) {
            if (data.player == myId) {
                myRole = data.role;
                $("#play_ground").show(100);
                $("#player_role")[0].innerText = myRole;
            }
        })
        socket.on('server-yeu-cau-cap-nhat-player-list', function (membersWithRole) {
            gameData = [...membersWithRole]
            $('#playerList').html("");
            membersWithRole.forEach(function (member) {
                if (myRole == "Mực nô đùa") {//normal player sight
                    $('#playerList').append('<li class="player">' + member.name + '</li>')
                }
                else {//redteam or merlin sight
                    if (member.role == "Mực gian tà" || member.role == "Mực the assassin")
                        $('#playerList').append('<li class="player" style="color: red">' + member.name + '</li>')
                    else $('#playerList').append('<li class="player">' + member.name + '</li>')
                }
            })
        })
        socket.on('server-gui-yeu-cau-teamup', function (pid) {
            if (myId == pid) {
                $('#playerList').html("");
                gameData.forEach(function (member) {
                    if (myRole == "Mực nô đùa") {//normal player sight
                        $('#playerList').append('<li class="player">' + member.name + '<input class="cbox" type="checkbox" value="' + member.name + '"></li>')
                    }
                    else {//redteam or merlin sight
                        if (member.role == "Mực gian tà" || member.role == "Mực the assassin")
                            $('#playerList').append('<li class="player" style="color: red">' + member.name + '<input class="cbox" type="checkbox" value="' + member.name + '"></li>')
                        else $('#playerList').append('<li class="player">' + member.name + '<input class="cbox" type="checkbox" value="' + member.name + '"></li>')
                    }
                })
                $('#teamleader').show(100);
            }
            //xu li so nguoi trong team dung theo rule
        })
        socket.on('server-gui-thong-tin-teamup', function (teamdata) {
            $('#system').show(100);

            $('#teammate').html("");
            
            teamdata.forEach(function (member) {
                $('#teammate').append('<li>' + member + '</li>')
            })

            $('#playerList').html("");
            gameData.forEach(function (member) {
                if (myRole == "Mực nô đùa") {//normal player sight
                    $('#playerList').append('<li class="player">' + member.name + '</li>')
                }
                else {//redteam or merlin sight
                    if (member.role == "Mực gian tà" || member.role == "Mực the assassin")
                        $('#playerList').append('<li class="player" style="color: red">' + member.name + '</li>')
                    else $('#playerList').append('<li class="player">' + member.name + '</li>')
                }
            })
            voteTeamResult = [];
        });

        socket.on('server-vote-team-fb-cho-host', function (data) { //{vote, pid, pname, prole, leaderid}
            if (isHost) {
                voteTeamResult.push({ vote: data[0], pid: data[1], pname: data[2], prole: data[3] });

                if (voteTeamResult.length == gameData.length) {
                    console.log("handle")
                    let voteCount = 0;
                    let vr;
                    voteTeamResult.forEach(function (data) {
                        if (data.vote) voteCount++;
                    })
                    if (voteCount > voteTeamResult.length / 2) {
                        vr = true;
                        socket.emit('host-gui-yeu-cau-vote-thanh-cong', gameData)
                    } else {
                        vr = false;
                        socket.emit('host-gui-yeu-cau-vote-lai', gameData)
                    }
                    socket.emit('host-gui-ket-qua-vote', [voteTeamResult, vr])
                }
            }
        })
        socket.on('server-vote-team-fb', function (data) { //{vote, pid, pname, prole}
            $('#playerList').html("");
            data[0].forEach(function (member) {
                console.log(member)
                let vr;
                if (member.vote) {
                    vr = '<span style="color: green">YES</span>'
                }
                else {
                    vr = '<span style="color: purple">NO</span>'
                }
                if (myRole == "Mực nô đùa") {//normal player sight
                    $('#playerList').append('<li class="player">' + member.pname + vr + '</li>')
                }
                else {//redteam or merlin sight
                    if (member.prole == "Mực gian tà" || member.prole == "Mực the assassin")
                        $('#playerList').append('<li class="player" style="color: red">' + member.pname + vr + '</li>')
                    else $('#playerList').append('<li class="player">' + member.pname + vr + '</li>')
                }
            })
            if(data[1])
                $('#playerList').append('<h3>Vote thanh cong</h3>')
            else $('#playerList').append('<h3>That bai</h3>')
        })
        //==============================================================================================

        let pname = $("#playerName")[0].innerText;
        let proom = $("#playerRoom")[0].innerText;
        // console.log(pname + ' -> ' + proom);
        $(document).ready(() => {
            socket.emit('client-gui-thong-tin-khoi-tao', {
                name: pname,
                room: proom
            })
        })
        $("#start_game").click(() => {
            $('#start_game').hide(100);
            socket.emit('client-start-game')
        })
        $("#go").click(() => {
            let teammate = [];
            let plist = document.getElementsByClassName('cbox')
            for (let i = 0; i < plist.length; i++) {
                if (plist[i].checked) {
                    teammate.push(plist[i].value.trim())
                }
            }
            $('#teamleader').hide(100);
            socket.emit('client-teamup-fb', teammate)
        })
        $("#TYes").click(() => {
            $('#system').hide(100);
            socket.emit('client-vote-team-fb', [true, myId, pname, myRole])
        })
        $(("#TNo")).click(() => {
            $('#system').hide(100);
            socket.emit('client-vote-team-fb', [false, myId, pname, myRole])
        })

    </script>
</body>

</html>